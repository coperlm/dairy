---
// DiaryList component - displays encrypted diary entries
---

<div class="min-h-screen p-4 md:p-8">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">ğŸ“” æˆ‘çš„æ—¥è®°</h1>
        <button
          id="logoutBtn"
          class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
        >
          é€€å‡º
        </button>
      </div>
    </div>
    
    <!-- Diary entries container -->
    <div id="diaryContainer" class="space-y-4">
      <div class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">æ­£åœ¨åŠ è½½æ—¥è®°...</p>
      </div>
    </div>
  </div>
</div>

<script>
  import CryptoJS from 'crypto-js';
  
  // æ£€æŸ¥è®¤è¯çŠ¶æ€
  const auth = sessionStorage.getItem('diary_auth');
  const passphrase = sessionStorage.getItem('diary_passphrase');
  
  if (!auth || !passphrase) {
    window.location.href = '/dairy/';
  }
  
  // é€€å‡ºç™»å½•
  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn?.addEventListener('click', () => {
    sessionStorage.clear();
    window.location.href = '/dairy/';
  });
  
  // ä½¿ç”¨ PBKDF2 ä»å£ä»¤æ´¾ç”Ÿå¯†é’¥(ä¸åç«¯ä¸€è‡´)
  function deriveKey(passphrase: string): string {
    const salt = 'diary-encryption-salt-2025';
    const iterations = 100000;
    const keySize = 256 / 32; // 32 bytes
    
    const key = CryptoJS.PBKDF2(passphrase, salt, {
      keySize: keySize,
      iterations: iterations,
      hasher: CryptoJS.algo.SHA256
    });
    
    return key.toString(CryptoJS.enc.Hex);
  }
  
  // è§£å¯†å‡½æ•°
  function decrypt(encryptedData: string, key: string): string {
    try {
      const bytes = CryptoJS.AES.decrypt(encryptedData, key);
      return bytes.toString(CryptoJS.enc.Utf8);
    } catch (error) {
      console.error('Decryption failed:', error);
      return '';
    }
  }
  
  // åŠ è½½å¹¶æ˜¾ç¤ºæ—¥è®°
  async function loadDiaries() {
    const container = document.getElementById('diaryContainer');
    if (!container) return;
    
    try {
      console.log('æ­£åœ¨åŠ è½½æ—¥è®°æ•°æ®...');
      
      // ä»å£ä»¤æ´¾ç”Ÿè§£å¯†å¯†é’¥
      const passphrase = sessionStorage.getItem('diary_passphrase');
      if (!passphrase) {
        throw new Error('æœªæ‰¾åˆ°å£ä»¤');
      }
      
      const decryptionKey = deriveKey(passphrase);
      console.log('å·²æ´¾ç”Ÿè§£å¯†å¯†é’¥');
      
      const response = await fetch('/dairy/diary-data.json');
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('æ•°æ®å·²åŠ è½½,ç‰ˆæœ¬:', data.version || '2.0');
      
      // è§£å¯†æ—¥è®°æ•°æ®
      console.log('å¼€å§‹è§£å¯†...');
      const decryptedJson = decrypt(data.data, decryptionKey);
      
      if (!decryptedJson) {
        throw new Error('è§£å¯†å¤±è´¥');
      }
      
      const diaries = JSON.parse(decryptedJson);
      console.log('æˆåŠŸè§£å¯†,æ—¥è®°æ•°é‡:', diaries.length);
      
      // æŒ‰æ—¥æœŸæ’åº
      diaries.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
      
      // æ¸²æŸ“æ—¥è®°åˆ—è¡¨
      container.innerHTML = diaries.map((diary: any) => `
        <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
          <div class="flex justify-between items-start mb-2">
            <h2 class="text-2xl font-bold text-gray-800">${diary.title}</h2>
            <span class="text-sm text-gray-500">${diary.date}</span>
          </div>
          <div class="prose max-w-none text-gray-700 whitespace-pre-wrap">
            ${diary.content}
          </div>
          ${diary.tags ? `
            <div class="mt-4 flex flex-wrap gap-2">
              ${diary.tags.map((tag: string) => `
                <span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm">
                  ${tag}
                </span>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `).join('');
      
    } catch (error) {
      console.error('åŠ è½½æ—¥è®°å¤±è´¥:', error);
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      container.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
          <p class="text-red-600 font-semibold">ğŸ˜• åŠ è½½æ—¥è®°å¤±è´¥</p>
          <p class="text-red-500 text-sm mt-2">${errorMessage}</p>
          <button
            onclick="sessionStorage.clear(); window.location.href='/dairy/';"
            class="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
          >
            é‡æ–°ç™»å½•
          </button>
        </div>
      `;
    }
  }
  
  // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
  loadDiaries();
</script>
