---
// DiaryList component - displays encrypted diary entries
---

<div class="min-h-screen p-4 md:p-8">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">ğŸ“” æˆ‘çš„æ—¥è®°</h1>
        <button
          id="logoutBtn"
          class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
        >
          é€€å‡º
        </button>
      </div>
    </div>
    
    <!-- Diary entries container -->
    <div id="diaryContainer" class="space-y-4">
      <div class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">æ­£åœ¨åŠ è½½æ—¥è®°...</p>
      </div>
    </div>
  </div>
</div>

<script>
  import CryptoJS from 'crypto-js';
  
  // æ£€æŸ¥è®¤è¯çŠ¶æ€
  const auth = sessionStorage.getItem('diary_auth');
  const key = sessionStorage.getItem('diary_key');
  
  if (!auth || !key) {
    window.location.href = '/dairy/';
  }
  
  // é€€å‡ºç™»å½•
  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn?.addEventListener('click', () => {
    sessionStorage.clear();
    window.location.href = '/dairy/';
  });
  
  // è§£å¯†å‡½æ•°
  function decrypt(encryptedData: string, password: string): string {
    try {
      const bytes = CryptoJS.AES.decrypt(encryptedData, password);
      return bytes.toString(CryptoJS.enc.Utf8);
    } catch (error) {
      console.error('Decryption failed:', error);
      return '';
    }
  }
  
  // åŠ è½½å¹¶æ˜¾ç¤ºæ—¥è®°
  async function loadDiaries() {
    const container = document.getElementById('diaryContainer');
    if (!container) return;
    
    try {
      // è¯»å–åŠ å¯†çš„æ—¥è®°ç´¢å¼•
      console.log('æ­£åœ¨åŠ è½½æ—¥è®°æ•°æ®...');
      const response = await fetch('/dairy/diary-data.json');
      console.log('Response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const encryptedData = await response.json();
      console.log('åŠ å¯†æ•°æ®å·²åŠ è½½, æ•°æ®é•¿åº¦:', encryptedData.data?.length);
      console.log('æ—¥è®°æ•°é‡:', encryptedData.count);
      
      // è§£å¯†æ—¥è®°æ•°æ®
      console.log('å¼€å§‹è§£å¯†...');
      const decryptedJson = decrypt(encryptedData.data, key!);
      console.log('è§£å¯†ç»“æœé•¿åº¦:', decryptedJson?.length);
      
      if (!decryptedJson) {
        throw new Error('è§£å¯†å¤±è´¥ï¼šè¿”å›ç©ºå­—ç¬¦ä¸²');
      }
      
      console.log('å¼€å§‹è§£æ JSON...');
      const diaries = JSON.parse(decryptedJson);
      console.log('æˆåŠŸè§£æï¼Œæ—¥è®°æ•°é‡:', diaries.length);
      
      // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      diaries.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
      
      // æ¸²æŸ“æ—¥è®°åˆ—è¡¨
      container.innerHTML = diaries.map((diary: any) => `
        <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">${diary.title}</h2>
          <div class="prose max-w-none text-gray-700">
            ${diary.content.replace(/\n/g, '<br>')}
          </div>
          ${diary.tags ? `
            <div class="mt-4 flex flex-wrap gap-2">
              ${diary.tags.map((tag: string) => `
                <span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm">
                  ${tag}
                </span>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `).join('');
      
    } catch (error) {
      console.error('åŠ è½½æ—¥è®°å¤±è´¥:', error);
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      container.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
          <p class="text-red-600 font-semibold">åŠ è½½æ—¥è®°å¤±è´¥</p>
          <p class="text-red-500 text-sm mt-2">è¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®æˆ–ç¨åé‡è¯•</p>
          <details class="mt-4 text-left">
            <summary class="cursor-pointer text-sm text-gray-600">æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</summary>
            <pre class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto">${errorMessage}</pre>
          </details>
        </div>
      `;
    }
  }
  
  // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
  loadDiaries();
</script>
