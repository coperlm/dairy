---
// Login component with password protection
---

<div class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“” æˆ‘çš„æ—¥è®°æœ¬</h1>
      <p class="text-gray-600">è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å†…å®¹</p>
    </div>
    
    <form id="loginForm" class="space-y-6">
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
          å¯†ç 
        </label>
        <input
          type="password"
          id="password"
          name="password"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
          placeholder="è¾“å…¥å¯†ç "
          required
        />
      </div>
      
      <div id="errorMessage" class="hidden text-red-500 text-sm text-center">
        å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•
      </div>
      
      <button
        type="submit"
        class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 shadow-lg hover:shadow-xl"
      >
        è¿›å…¥æ—¥è®°æœ¬
      </button>
    </form>
    
    <div class="mt-6 text-center text-sm text-gray-500">
      <p>ğŸ”’ æ‚¨çš„æ—¥è®°å·²åŠ å¯†ä¿æŠ¤</p>
    </div>
  </div>
</div>

<script>
  import CryptoJS from 'crypto-js';
  
  const form = document.getElementById('loginForm') as HTMLFormElement;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const errorMessage = document.getElementById('errorMessage') as HTMLElement;
  
  // ä»æœåŠ¡å™¨è¯»å–å£ä»¤å“ˆå¸Œ
  let PASSWORD_HASH = '';
  
  // åŠ è½½å£ä»¤å“ˆå¸Œ
  async function loadPasswordHash() {
    try {
      const response = await fetch('/dairy/passphrase-hash.txt');
      if (response.ok) {
        PASSWORD_HASH = (await response.text()).trim();
        console.log('å£ä»¤å“ˆå¸Œå·²åŠ è½½');
      } else {
        console.warn('æœªæ‰¾åˆ°å£ä»¤å“ˆå¸Œæ–‡ä»¶,ä½¿ç”¨é»˜è®¤å€¼');
        PASSWORD_HASH = '54b688a517f7654563a6c64d945a3670880a4c602ec67a065bbebbcd2b22edd5';
      }
    } catch (error) {
      console.error('åŠ è½½å£ä»¤å“ˆå¸Œå¤±è´¥:', error);
      PASSWORD_HASH = '54b688a517f7654563a6c64d945a3670880a4c602ec67a065bbebbcd2b22edd5';
    }
  }
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // å¦‚æœè¿˜æ²¡åŠ è½½å“ˆå¸Œ,å…ˆåŠ è½½
    if (!PASSWORD_HASH) {
      await loadPasswordHash();
    }
    
    const password = passwordInput.value;
    const hash = CryptoJS.SHA256(password).toString();
    
    if (hash === PASSWORD_HASH) {
      // å£ä»¤æ­£ç¡®,ä¿å­˜è®¤è¯çŠ¶æ€å’ŒåŸå§‹å£ä»¤(ç”¨äº PBKDF2 å¯†é’¥æ´¾ç”Ÿ)
      sessionStorage.setItem('diary_auth', 'true');
      sessionStorage.setItem('diary_passphrase', password);
      window.location.href = '/dairy/diary';
    } else {
      // å£ä»¤é”™è¯¯
      errorMessage.classList.remove('hidden');
      passwordInput.value = '';
      passwordInput.focus();
      
      setTimeout(() => {
        errorMessage.classList.add('hidden');
      }, 3000);
    }
  });
  
  // é¡µé¢åŠ è½½æ—¶é¢„åŠ è½½å“ˆå¸Œ
  loadPasswordHash();
</script>
